{% load comments %}

<div class="action-form">
    <h1>{% if ticket %}Edycja zgłoszenia{% else %}Nowe zgłoszenie{% endif %}</h1>
    {% if ticket %}<div class="warning-info">
    <p>Te zgłoszenie obejmuje poniższe urządzenia:</p>
    <ul>
    {% for d in devices %}
    <li id="device{{ d.pk }}">{{ d }}</li>
    {% endfor %}
    </ul>
    </div>{% endif %}
<form action="" method="POST" id="add-ticket">{% csrf_token %}
<table>
{# form.as_table #}
{% for f in form %}
{% if user.pielegniarka %}
{% if f.name not in "cyclic status" %}<tr><th>{{ f.label }}</th><td>{% if f.errors %}{{ f.errors }}{% endif %}{{ f }}</td></tr>{% endif %}
{% if f.name == "status" %}<input name="{{ f.name }}" type="hidden" value="0" />{% endif %}
{% else %}
<tr><th>{{ f.label }}</th><td>{% if f.errors %}{{ f.errors }}{% endif %}{{ f }}</td></tr>
{% endif %}
{% endfor %}
{% if ticket %}
{% get_comment_list for ticket as comment_list %}
<tr id="comments"><th>Komentarze</th><td><textarea id="id_comment" rows="4" cols="40" name="comment" placeholder="Dodaj komentarz..."></textarea>
<ul>
{% if comment_list %}
{% for c in comment_list reversed %}
<li><p>{{ c.comment }}<span>{{ c.user }}, {{ c.submit_date }}</span></p></li>
{% endfor %}
{% endif %}
</ul>

</td></tr>
{% endif %}
<tr id="submit-row"><td colspan="2"><input type="submit" value="{% if ticket %}Zapisz{% else %}Dodaj{% endif %}"></td></tr>
</table>
<input type="hidden" name="devices_id_list" value="{% for d in devices %}{{ d.pk }}{% if not forloop.last %},{% endif %}{% endfor %}" />
</form>
</div>
<script>
// Funkcja do pobrania tokena CSRF z ciasteczka
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

document.getElementById('add-ticket').addEventListener('submit', function(event) {
    event.preventDefault(); // zatrzymaj domyślne wysłanie formularza

    const form = event.target;
    const formData = new FormData(form);

    // Zamiana FormData na JSON (jeśli API oczekuje JSON)
    const data = {};
    formData.forEach((value, key) => {
        // Jeśli masz pola wielokrotnego wyboru, dostosuj tę logikę
        data[key] = value;
    });

    fetch(form.action || window.location.href, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data),
        credentials: 'include' // wysyła ciasteczka, ważne dla sesji i CSRF
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Błąd sieci: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('Sukces:', data);
        // tutaj możesz przekierować lub wyświetlić komunikat
    })
    .catch(error => {
        console.error('Błąd:', error);
    });
});
</script>
